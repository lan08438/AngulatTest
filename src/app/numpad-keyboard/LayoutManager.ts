import { Injectable } from '@angular/core'
//let electron_Instance = window['System']._nodeRequire('electron').remote; 
// let dbObj = window['System']._nodeRequire('./backend/dbapi/AppDB');
var Ttest_data={
    "AllData": [
        {
            "devicename": "GMMK NUMPAD",
            "SN": "0x320F0x504B",
            "name": "Layout 1",
            "value": 1,
            "m_Identifier": "1",
            "content": {
              "AllBlockColor": [
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                },
                {
                  "clearStatus": false,
                  "color": [
                    0,
                    0,
                    0,
                    0
                  ],
                  "breathing": false
                }
              ],
              "lightData": {
                "speed": 50,
                "brightness": 50,
                "clearStatus": false,
                "colorHex": "#0000",
                "colorPickerValue": [
                  255,
                  0,
                  0,
                  1
                ],
                "breathing": false,
                "sideLightSync": false,
                "sideLightColor": [
                  0,
                  0,
                  0,
                  0
                ],
                "brightness_Enable": false,
                "rate_Enable": false,
                "color_Enable": false
              }
            }
          }
    ],
    "_id": "S21tw2mhN6A65aVZnS"
  }
export class LayoutManager {
    //dbService = electron_Instance.getGlobal('AppProtocol').deviceService.nedbObj
    //dbService= dbObj.getInstance();
    nowEditName = ''
    maxkaycapNumber=0;
    layoutSelectData: any = [];
    nowlayoutSelect: any;
    defaultData={};
    deviceObj
    //CommonService:CommonService;
    //commonService=new CommonService();
    //translate=TranslateService;
    static instance;
    layoutDBdata;
    constructor(maxkayNumber,devicename="GMMK V2 65US"){
        console.log('LayoutManager_constructor',maxkayNumber,devicename);
        // this.maxkaycapNumber=maxkayNumber;
        this.getLayoutFromDB();
    }
    static getInstance() {
        console.log('LayoutManager_getInstance',this.instance);
        if (this.instance) {
            return this.instance;
        }
        else {
            this.instance = new LayoutManager(83,'GMMK V2 65US');
            return this.instance;
        }
    }
    
    setLayoutDevice(maxkayNumber,deviceObj){
        this.maxkaycapNumber=maxkayNumber;
        this.deviceObj=deviceObj;
        this.setLayoutDBdata();    
    }
    getLayoutFromDB() {
        this.layoutDBdata=Ttest_data.AllData;
        console.log('%c  getLayoutFromDB.layoutDBdata', 'background: blue; color: red',  Ttest_data);

        // return new Promise((resolve, reject) => {
        //     this.dbService.getLayout().then((T_data: any) => {
        //         console.log('dbService.getLayoutFromDB()_data',T_data,this.layoutDBdata);
        //         this.layoutDBdata=T_data[0].AllData;
        //         resolve()
        //     })
        // })
    }

    setLayoutDBdata() {
        let Temp = []
        Temp.push(this.defaultModule());
        //Temp[0].name = this.getTranslate('NewMacro');
        Temp[0].name = 'New Layout';
        console.log('layoutDBdata.filter_deviceObj',this.deviceObj);
        let _this=this;
        var T_data = this.layoutDBdata.filter(function (item, index, array) {
            if (item.SN == _this.deviceObj.SN) {
                return item;//回傳符合條件的
            }
        });
        console.log('dbService.setLayoutDBdata().serachData', T_data);
        if (T_data.length < 1) {
            console.error('DB is Null',this.deviceObj.SN);
            return;
        }
        var deviceData = [];
        for (let i = 0; i < T_data.length; i++) {
            if (T_data[i].SN == this.deviceObj.SN) {
                deviceData.push(T_data[i]);
            }
        }
        var data = this.ArraySort(deviceData, 'value');

        for (let i = 0; i < data.length; i++) {
                Temp.push(this.transformJson(data[i]));
        }
        this.layoutSelectData = Temp;
        this.nowlayoutSelect = this.layoutSelectData[1]
        console.log('setLayoutDBdata', Temp, this.nowlayoutSelect);

        this.nowEditName = this.nowlayoutSelect.name;


    }
    reArraySortData(){
        this.ArraySort(this.layoutSelectData, 'value')
    }
    
    getMacroFromIdentifier(){
        var Target = this.layoutSelectData.find((x) => x.value == this.nowlayoutSelect.value)
        if(Target==undefined){
        alert('this.nowlayoutSelect.m_Identifier='+this.nowlayoutSelect.m_Identifier);
        }
        console.log('getMacroFromIdentifier', Target);
        return Target
    }

    getCompareMacroName(Searchm_Identifier) {
        var target = this.layoutSelectData.find((x) => x.m_Identifier == Searchm_Identifier)
        if(target==undefined){
        console.error('getCompareMacroName_Error',Searchm_Identifier);
        }
        return target.name
    }

	/**
	 * 排列Array順序
	 * @param array 
	 * @param key 
	 */
    ArraySort(array, key) {
        return array.sort(function(a, b) {
            var x = a[key];
            var y = b[key];
            return x - y;
        });
	}
    setCompareSelectValue(Searchm_value) {
        var target = this.layoutSelectData.find((x) => x.value == Searchm_value);
        if(target==undefined){
        console.error('setCompareMacroSelect_Error_Reset_Zero',Searchm_value,this.layoutSelectData);
        target=this.layoutSelectData.find((x) => x.value == 1);
        return false;
        }
        console.log('setCompareMacroSelect',Searchm_value,target);
        this.nowlayoutSelect=target;
        this.nowEditName= this.nowlayoutSelect.name;
        return true;
    }
    defaultModule(type = '') {
        var T = {
            name:'NewLayout',
            value:0,
            m_Identifier:'',
            content:{},
            SN:"Error",
            devicename:'Error'
        }
        return T
    }

    // setLanguageName(){
    //     this.layoutSelectData[0].name =this.getTranslate('NewMacro');
    // }
    getDefaultData() {
        return JSON.parse(JSON.stringify(this.defaultData));
    }
    transformJson(data){
        return JSON.parse(JSON.stringify(data));
    }
    updateContentToDB(AllBlockColor,in_lightData){
        console.log('updateContentToDB_stringify', JSON.stringify(AllBlockColor));

        AllBlockColor=this.transformJson(AllBlockColor);
        in_lightData=this.transformJson(in_lightData);

        for (let index = 0; index < AllBlockColor.length; index++) {
            var element = AllBlockColor[index];
            
            delete element.coordinateData;
            delete element.border;
            delete element.keyCode;
        }
        var content= {
            AllBlockColor:AllBlockColor,
            lightData:in_lightData,
        }
        console.log('updateContentToDB', content);

        this.UpdateLayout(this.nowEditName,content);
    }
    getNotRepeatData(newData) {
        var TempName = newData.name
        let i = 1
        while (1) {
            let flag = this.find_Data_Exist('name', TempName);
            if (flag) {
                TempName = newData.name + '-' + i
                i++
            } else {
                newData.name = TempName
                break
            }
        }
        var temp_id = newData.m_Identifier;
        while (1) {
            let flag = this.find_Data_Exist('m_Identifier', temp_id);
            if (flag) {
                temp_id = String(new Date().getTime());
            }
            else {
                newData.m_Identifier = temp_id;
                break
            }
        }
        var temp_value = newData.value;
        while (1) {
            let flag = this.find_Data_Exist('value', temp_value);
            if (flag) {
                temp_value +=1;
            }
            else {
                newData.value = temp_value;
                break
            }
        }
        this.layoutSelectData.push(newData);
        this.layoutDBdata.push(newData);
        this.nowlayoutSelect = newData;
        this.nowEditName = this.nowlayoutSelect.name;
        return newData

    }
    addNewLayout() {
            var colorArr=[];
            for (let index = 0; index < this.maxkaycapNumber; index++) {
                colorArr.push({ 
                    clearStatus:false,
                    color: [0,0,0,0],
                    breathing:false,
                    border: true,
                    coordinateData:[],
                    keyCode:''}
                    )
            }
            var tempObj = this.defaultModule();
            tempObj.content ={
                AllBlockColor:colorArr,
                lightData:this.getDefaultData()
            };
            tempObj.name='Layout 1';
            tempObj.SN=this.deviceObj.SN;
            tempObj.devicename=this.deviceObj.devicename;
            this.nowEditName = this.nowlayoutSelect.name;
            var r_tempObj=this.getNotRepeatData(tempObj);
            this.setLayoutAlldata().then(() => {
                console.log('%c setLayoutAlldata', 'color:rgb(255,75,255,1)', this.layoutDBdata);
            })
    }

    setLayoutAlldata() {
        var _this=this;
        return new Promise(function (resolve, reject) {
            console.log('%c updateLayoutAlldata_this.', 'color:rgb(255,75,255,1)', _this);

            var compareData = {
                "_id": "S21tw2mhN6A65aVZnS",
            }
            // _this.dbService.updateLayoutAlldata(compareData, _this.layoutDBdata).then(() => {
            //     console.log('%c updateLayoutAlldata', 'color:rgb(255,75,255,1)', _this.layoutDBdata);
            //     resolve();
            // })
        });
    }



    importLayoutData(Obj){
        for (let index = 0; index < Obj.length; index++) {
            var r_tempObj = Obj[index];
            this.layoutSelectData.push(r_tempObj);
            this.layoutDBdata.push(r_tempObj);
            this.nowlayoutSelect = r_tempObj;
            this.nowEditName = this.nowlayoutSelect.name;
        }
            
    }
    deletLayout(MacroItem) {
        return new Promise((resolve, reject) => {
            if (this.layoutSelectData.length > 2) {
                console.log('deletMacro',  this.nowlayoutSelect.value);
               // this.getMacroFromIdentifier()
                let TempArray = JSON.parse(JSON.stringify(this.layoutSelectData))
                let index = this.layoutSelectData.findIndex((x) => x.value == this.nowlayoutSelect.value)
                if(index!=-1){
                    TempArray.splice(index, 1);
                }
                this.layoutSelectData = TempArray
                this.nowlayoutSelect = this.layoutSelectData[
                    this.layoutSelectData.length - 1
                ]
                this.nowEditName = this.nowlayoutSelect.name
                
                var db_index=this.layoutDBdata.findIndex((x) => x.value == this.nowlayoutSelect.value&&x.SN==this.nowlayoutSelect.SN);
                if(db_index!=-1){
                    this.layoutDBdata.splice(index, 1);
                }
                else{
                    console.log('%c deletLayout_error', 'color:rgb(255,75,255,1)', this.layoutDBdata);    
                    return; 
                }
                this.setLayoutAlldata().then(() => {
                    console.log('%c setLayoutAlldata', 'color:rgb(255,75,255,1)', this.layoutDBdata);
                })
            }
        })
    }
    UpdateLayout(Name, Data) {
        var target=this.getMacroFromIdentifier();
        target.name = Name;
        target.content = Data;
        this.nowEditName = Name;
        console.log('UpdateLayout_',target)
        var db_index=this.layoutDBdata.findIndex((x) => x.value == this.nowlayoutSelect.value&&x.SN==this.nowlayoutSelect.SN);
        if(db_index!=-1){
            this.layoutDBdata[db_index]=this.transformJson(target);
        }
        else{
            console.log('%c UpdateLayout_error', 'color:rgb(255,75,255,1)', this.layoutDBdata);    
            return; 
        }
        this.setLayoutAlldata().then(() => {
            console.log('%c setLayoutAlldata', 'color:rgb(255,75,255,1)', this.layoutDBdata);
        })
    }

    setMacroSelectData(value) {
        let MacroIndex = this.layoutSelectData.findIndex(
            (x) => x.value == value
        )
        if (MacroIndex != -1) {
            this.nowlayoutSelect = this.layoutSelectData[MacroIndex]
            this.nowEditName = this.nowlayoutSelect.name
        }
    }

    check_m_Identifier(Search_value){
        return this.layoutSelectData.findIndex((x) => x.m_Identifier == Search_value);
    }
    check_Exist(field,Search_value){
        return this.layoutSelectData.findIndex((x) => x[field] == Search_value);
    }

    NameInputBlur(){
            if(this.nowEditName==""){
                this.nowEditName=" "
            }
            let TempName = this.nowEditName;
            let i = 1
            while (1) {
                let flag = this.layoutSelectData.findIndex((x) => x.name == TempName)
                if (flag != -1&&TempName!=this.nowlayoutSelect.name){
                    TempName = this.nowEditName + '-' + i
                    i++
                } else {
                    this.nowEditName = TempName;
                    break
                }
            }
            this.getMacroFromIdentifier().name = this.nowEditName;
            console.log('setNameInputBlur',this.layoutSelectData);
            this.layoutSelectData = JSON.parse(JSON.stringify(this.layoutSelectData));
            this.nowlayoutSelect=JSON.parse(JSON.stringify(this.getMacroFromIdentifier()));

            this.UpdateLayout(this.getMacroFromIdentifier().name,this.getMacroFromIdentifier().content);
    }
    setSelectChange() {
        if (this.nowlayoutSelect.value == 0) {//New Macro
            this.addNewLayout();
        } else {
            this.nowEditName = this.nowlayoutSelect.name
        }
    }
    find_Data_Exist(field,value){
        var Target = this.layoutSelectData.find((x) => x[field] == value)
        if(Target==undefined){
        //console.error('this.nowlayoutSelect.m_Identifier', this.nowlayoutSelect.m_Identifier);
        console.log('find_Data_Exist_fail',field,value);
        return false;
        }
        else{
            return true;
        }
    }
    find_Data(field,value){
        var Target = this.layoutSelectData.find((x) => x[field] == value)      
        if(Target==undefined){
        console.log('find_Data_fail',field,value);
        return Target; 
        }
        else{
            return Target;        
        }
    }    
}
